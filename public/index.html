<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receipt management</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 1.5rem 4rem;
      background-color: #eef2f6;
    }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    .form-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .form-row input[type="file"] { margin-bottom: 0; }
    .upload-success-msg {
      color: #166534;
      font-size: 0.95rem;
    }
    .upload-success-msg:empty { display: none; }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #message {
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      min-height: 2.5rem;
    }
    #message.success { background: #dcfce7; color: #166534; }
    #message.error { background: #fee2e2; color: #991b1b; }
    #message:empty { display: none; }
    #result { margin-top: 0.75rem; display: none; }
    #result.visible { display: block; }
    .result-layout {
      display: grid;
      grid-template-columns: minmax(280px, 1fr) minmax(320px, 1fr);
      gap: 1rem;
      align-items: start;
    }
    @media (max-width: 720px) {
      .result-layout { grid-template-columns: 1fr; }
    }
    #result h2 { display: none; }
    .receipt-column { min-width: 0; }
    .receipt-image-wrapper {
      position: relative;
      display: inline-block;
      max-width: 100%;
      width: 100%;
    }
    #receipt-image {
      display: block;
      max-width: 100%;
      width: 100%;
      max-height: 75vh;
      object-fit: contain;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    .receipt-overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .receipt-overlay .region-frame {
      position: absolute;
      border: 2px solid #2563eb;
      background: rgba(37, 99, 235, 0.08);
      box-sizing: border-box;
    }
    .receipt-overlay .region-label {
      position: absolute;
      font-size: 0.75rem;
      font-weight: 600;
      color: #2563eb;
      white-space: nowrap;
      text-shadow: 0 0 2px #fff, 0 0 4px #fff;
    }
    #parsed-entries {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    #parsed-entries th, #parsed-entries td {
      text-align: left;
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }
    .data-column { min-width: 0; }
    #parsed-entries thead { display: none; }
    #parsed-entries th {
      color: #374151;
      font-weight: 500;
      white-space: nowrap;
      min-width: 5em;
      padding-right: 0.75rem;
    }
    #parsed-entries td.parsed-missing { color: #6b7280; font-style: italic; }
    #parsed-entries .parsed-roi-cell {
      padding: 0.25rem 0.5rem;
      vertical-align: middle;
      font-size: 0.85rem;
      color: #6b7280;
      max-width: 180px;
    }
    #parsed-entries .parsed-roi-cell img {
      display: block;
      max-width: 120px;
      max-height: 48px;
      width: auto;
      height: auto;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
    }
    .build-number {
      position: fixed;
      bottom: 0.5rem;
      right: 0.5rem;
      font-size: 0.7rem;
      color: #9ca3af;
      font-weight: normal;
      pointer-events: none;
    }
    .footer-meta {
      position: fixed;
      bottom: 0.5rem;
      right: 0.5rem;
      font-size: 0.7rem;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      pointer-events: none;
    }
    .footer-meta .build-number {
      position: static;
    }
    #result .result-actions {
      margin-top: 0.5rem;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    #result .result-actions-message {
      padding: 0.35rem 0.6rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    #result .result-actions-message.success { background: #dcfce7; color: #166534; }
    #result .result-actions-message.error { background: #fee2e2; color: #991b1b; }
    #result .result-actions-message:empty { display: none; }
    #parsed-entries input[type="text"] {
      width: 100%;
      max-width: 100%;
      padding: 0.35rem 0.5rem;
      font-size: inherit;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1>Receipt management</h1>
  <form id="form">
    <label for="image">Receipt image (Chinese 发票)</label>
    <div class="form-row">
      <input type="file" id="image" name="image" accept="image/jpeg,image/png,image/webp,image/gif" required>
      <button type="submit" id="submit">Upload</button>
      <span id="upload-success-msg" class="upload-success-msg" aria-live="polite"></span>
    </div>
  </form>
  <div id="message" role="status"></div>
  <section id="result" aria-label="Uploaded receipt result">
    <div class="result-layout">
      <div class="receipt-column">
        <h2 id="result-heading">Receipt</h2>
        <div class="receipt-image-wrapper" id="receipt-image-wrapper">
          <img id="receipt-image" alt="Uploaded receipt" src="">
          <div class="receipt-overlay" id="receipt-overlay" aria-hidden="true"></div>
        </div>
      </div>
      <div class="data-column">
        <table id="parsed-entries" aria-label="Parsed receipt data">
          <thead>
            <tr>
              <th scope="col">Field</th>
              <th scope="col">Value</th>
              <th scope="col">ROI</th>
            </tr>
          </thead>
          <tbody id="parsed-entries-body"></tbody>
        </table>
        <p class="result-actions">
          <button type="button" id="accept-receipt-btn">Accept</button>
          <span id="accept-message" class="result-actions-message" role="status"></span>
        </p>
      </div>
    </div>
  </section>
  <footer class="footer-meta" aria-hidden="true">
    <span class="build-number" id="build-timestamp"></span>
  </footer>
  <script src="app.js"></script>
  <script>
    fetch('/api/build').then(function(r){ return r.json(); }).then(function(d){
      var el = document.getElementById('build-timestamp');
      if (el && d.timestamp) el.textContent = d.timestamp;
    }).catch(function(){});
  </script>
</body>
</html>
